<html>
<head>
<title>Whack</title>
<style>
#field {
    width: 800px;
    height: 400px;
    border: 1px solid black;
}
</style>
</head>

<body>

<canvas id="field" width="800" height="400"></canvas>
<script>

function random(min, max) {
	return  Math.floor(Math.random() * (max - min + 1)) + min;
}

function Field(width, height, rowHeight) {
	this.width = width;
	this.height = height;
	this.rowHeight = rowHeight;

	this.draw = function(ctx) {
		for (var i = 0; i < this.height; i = i + this.rowHeight) {
			ctx.beginPath();
			ctx.moveTo(0, i);
			ctx.lineTo(this.width, i);
			ctx.stroke();
		}
	}
}

function Scene(ctx) {
	this.ctx = ctx;

	this.drawField = function(field) {
		ctx.clearRect(0, 0, field.width, field.height);
		for (var i = 0; i < field.height; i = i + field.rowHeight) {
			ctx.beginPath();
			ctx.moveTo(0, i);
			ctx.lineTo(field.width, i);
			ctx.stroke();
			ctx.closePath();
		}
		ctx.beginPath();
		ctx.moveTo(field.rowHeight, 0);
		ctx.lineTo(field.rowHeight, field.height);
		ctx.stroke();
		ctx.closePath();
	}

	this.drawCritters = function(critters) {
		for (var i = 0; i < critters.length; i++) {
			var c = critters[i];
			ctx.save();
			ctx.beginPath();
			ctx.fillStyle = c.color;
			ctx.arc(c.x, c.y, c.r, 0, 2*Math.PI);
			ctx.fill();
			ctx.closePath();
			ctx.restore();
		}
	}

	this.drawBullets = function(bullets) {
		for (var i = 0; i < bullets.length; i++) {
			var b = bullets[i];
			ctx.save();
			ctx.beginPath();
			ctx.fillStyle = b.color;
			ctx.arc(b.x, b.y, b.r, 0, 2*Math.PI);
			ctx.fill();
			ctx.closePath();
			ctx.restore();
		}
	}

	this.drawTurrets = function(turrets) {
		for (var i = 0; i < turrets.length; i++) {
			var t = turrets[i];
			if (!t) {
				continue;
			}
			var x = t.field.rowHeight + 5;
			var y = t.row * t.field.rowHeight + 5;
			ctx.save();
			ctx.beginPath();
			ctx.fillStyle = t.color;
			ctx.rect(x, y, 40, 40);
			ctx.fill();
			ctx.closePath();
			ctx.restore();
		}
	}	
}

function Game(field, scene) {
	this.field = field;
	this.scene = scene
	this.critters = new Array();
	this.running = 0;
	this.currentTime = 0;
	this.previousTime = 0;
	this.elapsed = 0;
	this.critterID = 0;
	this.bulletID = 0;
	this.turrets = new Array(this.field.height / this.field.rowHeight);
	this.bullets = new Array();

	this.setup = function() {
		this.spawnCritter();
	}

	this.draw = function() {
		scene.drawField(this.field);
		scene.drawCritters(this.critters);
		scene.drawTurrets(this.turrets);
		scene.drawBullets(this.bullets);
	}

	this.spawnCritter = function() {
		var critter = new Critter(random(0, 7), random(15, 23), this.field, this.critterID);
		this.critters.push(critter);
		this.critterID++;
	}

	this.spawnTurret = function(y) {
		var row = Math.floor(y / this.field.rowHeight);
		if (this.turrets[row]) {
			return;
		}
		var turret = new Turret(row, this.field, this.currentTime);
		this.turrets[row] = turret;
	}

	this.run = function(t) {
		this.previousTime = this.currentTime;
		this.currentTime = t;
		this.elapsed += this.currentTime - this.previousTime;
		var n = random(2, 4);
		if (this.elapsed >= n * 1000) {
			this.elapsed = 0;
			this.spawnCritter();
		}
		for (var i = 0; i < this.bullets.length; i++) {
			this.bullets[i].update();
			if (this.bullets[i].x + this.bullets[i].r > this.field.width) {
				this.removeBullet(this.bullets[i]);
			}
		}
		for (var i = 0; i < this.critters.length; i++) {
			this.critters[i].update();
			var hitters = this.critters[i].hit(this.bullets);
			console.log("hitters", hitters);
			for (var j = 0; j < hitters.length; j++) {
				this.removeBullet(hitters[j]);
			}
			if (this.critters[i].isDead()) {
				this.removeCritter(this.critters[i]);
			}
		}
		for (var i = 0; i < this.turrets.length; i++) {
			if (!this.turrets[i]) {
				continue;
			}
			var b = this.turrets[i].shoot(t);
			if (b) {
				this.bulletID++;
				b.id = this.bulletID;
				this.bullets.push(b);
			}
		}
		this.draw();
		var end = false;
		for (var i = 0; i < this.critters.length; i++) {
			if (this.critters[i].checkEnd()) {
				end = true;
				break;
			}
		}
		if (end) {
			cancelAnimationFrame(this.running);
		}
		else {
			var that = this;
			this.running = requestAnimationFrame(function(t) {
				that.run(t);
			});
		}
	}

	this.click = function(x, y) {
		var toRemove = new Array();
		for (var i = 0; i < this.critters.length; i++) {
			this.critters[i].hit(x, y);
			if (this.critters[i].life == 0) {
				toRemove.push(this.critters[i]);
			}
		}
		if (toRemove.length > 0) {
			 for(var i = 0; i < toRemove.length; i++) {
			 	this.removeCritter(toRemove[i]);
			 }
		}
	}

	this.removeCritter = function(critter) {
		var index = -1;
		for (var i = 0; i < this.critters.length; i++) {
			if (this.critters[i].id == critter.id) { 
				index = i;
				break;
			}
		}
		if (index > -1) {
			this.critters.splice(index, 1);
		}
	}

	this.removeBullet = function(bullet) {
		console.log("b", bullet);
		var index = -1;
		for (var i = 0; i < this.bullets.length; i++) {
			if (this.bullets[i].id == bullet.id) {
				index = i;
				break; 
			}
		}
		if (index > -1) {
			this.bullets.splice(index, 1);
		}
	}
}

function Bullet(row, id) {
	this.row = row;
	this.r = 5;
	this.x = 50 + 5 + 40; //TODO: remove magic numbers;
	this.y = row * 50 + 25; //TODO: remove magic numbers;
	this.color = "red";
	this.speed = 2;
	this.id = id;

	this.update = function() {
		this.x = this.x + this.speed;
	}
}
 
function Turret(row, field, currentTime) {
	this.row = row;
	this.field = field;
	this.color = "black";
	this.previousTime = currentTime;
	this.currentTime = currentTime;
	this.elapsed = 0;

	this.shoot = function(t) {
		console.log("Shoot?");
		this.previousTime = this.currentTime;
		this.currentTime = t;
		this.elapsed += this.currentTime - this.previousTime;
		if (this.elapsed >= 1000) {
			this.elapsed = 0;
			return this.spawnBullet();
		}
	}

	this.spawnBullet = function() {
		console.log("pewpew");
		var bullet = new Bullet(this.row);
		return bullet;
	}
}

function Critter(row, r, field, id) {
	this.row = row;
	this.x = field.width - r - 5;
	this.field = field;
	this.y = row * field.rowHeight + (field.rowHeight / 2);
	this.r = r;
	this.color = "red";
	this.speed = random(1, 2);
	this.life = 2;
	this.id = id;

	this.update = function() {
		this.x = this.x - this.speed;
	}

	this.checkEnd = function() {
		return (this.x <= 0 + (this.field.rowHeight - this.r));
	}

	this.hit = function(bullets) {
		var hitters = new Array();
		for (var i = 0; i < bullets.length; i++) {
			var b = bullets[i];
			if (this.row != b.row) {
				continue;
			}
			if (b.x + b.r >= this.x - this.r) {
				console.log("I'm dead"); //TODO implement 
				this.life--;
				this.color = "green";
				hitters.push(b);
			}
		}
		return hitters;
	}

	this.isDead = function() {
		return this.life <= 0;
	}
}



document.addEventListener("DOMContentLoaded", function() {
	var canvas = document.getElementById("field");
	var ctx = canvas.getContext('2d');
	var field = new Field(800, 400, 50);
	var scene = new Scene(ctx);
	var game = new Game(field, scene);

	canvas.addEventListener("click", function(event) {
        var elemLeft = canvas.offsetLeft;
        var elemTop = canvas.offsetTop;
        var x = event.pageX - elemLeft;
        var y = event.pageY - elemTop;
        //game.click(x, y);
        game.spawnTurret(y);
    });

	game.setup();
	game.draw();
	game.running = requestAnimationFrame(function(t) {
		game.run(t);
	});

});

</script>
</body>
</html>